<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tetris Pro</title>

<style>
body{
  margin:0;
  background:#020617;
  color:#e5e7eb;
  font-family:system-ui;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.wrap{
  background:#020617;
  padding:16px;
  border-radius:16px;
  box-shadow:0 30px 80px rgba(0,0,0,.7);
}
.top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
select,button{
  background:#0f172a;
  color:#e5e7eb;
  border:1px solid #1e293b;
  padding:6px 10px;
  border-radius:8px;
}
canvas{
  background:#020617;
  display:block;
  border-radius:10px;
}
.info{
  display:flex;
  justify-content:space-between;
  margin-top:8px;
}
.touch{
  display:grid;
  grid-template-columns:repeat(3,60px);
  gap:8px;
  justify-content:center;
  margin-top:12px;
}
.touch button{
  height:48px;
  font-size:18px;
}
.rank{
  font-size:12px;
  margin-top:10px;
  color:#94a3b8;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <select id="mode">
      <option value="classic">ç»å…¸æ¨¡å¼</option>
      <option value="time">é™æ—¶æ¨¡å¼</option>
      <option value="hell">åœ°ç‹±æ¨¡å¼</option>
      <option value="bomb">å½©è‰²ç‚¸å¼¹</option>
    </select>
    <button onclick="toggleMusic()">ğŸµ</button>
  </div>

  <canvas id="c" width="300" height="600"></canvas>

  <div class="info">
    <div>åˆ†æ•° <span id="score">0</span></div>
    <div>æ—¶é—´ <span id="time">--</span></div>
  </div>

  <div class="touch">
    <button onclick="move(-1)">â†</button>
    <button onclick="rotate()">âŸ³</button>
    <button onclick="move(1)">â†’</button>
    <button onclick="drop()">â†“</button>
    <button onclick="hardDrop()">â¤“</button>
    <button onclick="reset()">âŸ²</button>
  </div>

  <div class="rank" id="rank"></div>
</div>

<script>
/* ========= éŸ³æ•ˆ ========= */
const audio = new AudioContext();
let musicOn=true;
function beep(freq,d=0.08){
  if(!musicOn) return;
  const o=audio.createOscillator(),g=audio.createGain();
  o.connect(g); g.connect(audio.destination);
  o.frequency.value=freq;
  g.gain.value=.08;
  o.start(); o.stop(audio.currentTime+d);
}

/* ========= æ¸¸æˆå‚æ•° ========= */
const cvs=c.getContext("2d");
const COL=10,ROW=20,S=30;
let board,cur,score=0,mode="classic",time=120,dropSpeed=800,timer;

/* ========= æ–¹å— ========= */
const colors=["", "#22d3ee","#a78bfa","#34d399","#facc15","#fb7185","#60a5fa","#f97316","#fde047"];
const shapes=[
  [[1,1,1,1]],
  [[2,0,0],[2,2,2]],
  [[0,3,3],[3,3,0]],
  [[4,4],[4,4]],
  [[0,5,0],[5,5,5]],
  [[6,6,0],[0,6,6]],
  [[7,7,7],[0,7,0]],
  [[8]]
];

/* ========= æ ¸å¿ƒ ========= */
function reset(){
  board=Array.from({length:ROW},()=>Array(COL).fill(0));
  score=0; time=120;
  newPiece();
  clearInterval(timer);
  if(mode==="time"){
    timer=setInterval(()=>{time--;if(time<=0)gameOver()},1000);
  }
}
function newPiece(){
  let s=shapes[Math.random()*shapes.length|0];
  cur={s,x:3,y:0};
  if(hit()) gameOver();
}
function hit(){
  return cur.s.some((r,y)=>r.some((v,x)=>{
    let px=x+cur.x, py=y+cur.y;
    return v && (px<0||px>=COL||py>=ROW||board[py]?.[px]);
  }));
}
function merge(){
  cur.s.forEach((r,y)=>r.forEach((v,x)=>{
    if(v) board[y+cur.y][x+cur.x]=v;
  }));
}
function clear(){
  let n=0;
  board=board.filter(r=>{
    if(r.every(v=>v)){n++; return false;}
    return true;
  });
  while(board.length<ROW) board.unshift(Array(COL).fill(0));
  if(n){score+=n*100;beep(600);}
}
function drop(){
  cur.y++;
  if(hit()){cur.y--;merge();clear();newPiece();}
}
function hardDrop(){
  while(!hit())cur.y++;
  cur.y--;merge();clear();newPiece();
}
function move(d){
  cur.x+=d;
  if(hit()) cur.x-=d;
}
function rotate(){
  cur.s=cur.s[0].map((_,i)=>cur.s.map(r=>r[i]).reverse());
  if(hit()) cur.s=cur.s[0].map((_,i)=>cur.s.map(r=>r[r.length-1-i]));
}

/* ========= æ¸²æŸ“ ========= */
function draw(){
  cvs.clearRect(0,0,300,600);
  board.forEach((r,y)=>r.forEach((v,x)=>{
    if(v){cvs.fillStyle=colors[v];cvs.fillRect(x*S,y*S,S-1,S-1);}
  }));
  cur.s.forEach((r,y)=>r.forEach((v,x)=>{
    if(v){cvs.fillStyle=colors[v];cvs.fillRect((x+cur.x)*S,(y+cur.y)*S,S-1,S-1);}
  }));
  scoreEl.innerText=score;
  timeEl.innerText=mode==="time"?time:"âˆ";
}

/* ========= æ’è¡Œæ¦œ ========= */
function saveRank(){
  let k="tetris-"+mode;
  let r=JSON.parse(localStorage.getItem(k)||"[]");
  r.push(score); r.sort((a,b)=>b-a); r=r.slice(0,5);
  localStorage.setItem(k,JSON.stringify(r));
  rank.innerHTML="æ’è¡Œæ¦œï¼š"+r.join(" / ");
}

/* ========= ç»“æŸ ========= */
function gameOver(){
  saveRank();
  beep(120,0.4);
  alert("æ¸¸æˆç»“æŸ");
  reset();
}

/* ========= å¾ªç¯ ========= */
let last=0;
function loop(t){
  if(t-last>dropSpeed){drop();last=t;}
  draw();
  requestAnimationFrame(loop);
}

/* ========= æ§åˆ¶ ========= */
document.onkeydown=e=>{
  if(e.key==="ArrowLeft")move(-1);
  if(e.key==="ArrowRight")move(1);
  if(e.key==="ArrowDown")drop();
  if(e.key==="ArrowUp")rotate();
  if(e.key===" ")hardDrop();
};
modeSel.onchange=e=>{mode=e.target.value;dropSpeed=mode==="hell"?200:800;reset();};
function toggleMusic(){musicOn=!musicOn;}

/* ========= å¯åŠ¨ ========= */
reset(); loop();
</script>
</body>
</html>
